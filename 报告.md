# 基于深度度量学习的掌纹认证研究

## 一、题目与概述

**题目**：基于深度度量学习的掌纹认证研究

- **研究模态**：手部生物特征模态中的掌纹（Palmprint）
- **任务类型**：1:1 认证（Verification）
- **核心方法**：以深度度量学习（Deep Metric Learning）为核心，结合分类学习辅助训练。
- **关键技术**：
  - **损失函数**：对比损失（Contrastive Loss）、三元组损失（Triplet Loss）、角度间隔损失（ArcFace）。
  - **网络架构**：传统卷积网络（INet/ResNet）与最新可重参数化轻量网络（MobileOne）的对比研究。

---

## 二、数据库详解

### 2.1 数据库来源与采集方式

- **数据库名称**：**PalmBigDataBase**（课程专用数据库，不对外公开）。
- **采集方式**：**接触式采集**。受试者将手掌放置在固定采集装置上，经过背景抑制与 ROI（Region of Interest）裁剪后，仅保留掌纹区域。
- **数据特点**：图像已对齐并居中，背景纯净，是标准的掌纹识别/认证基准数据。

### 2.2 图像基础信息

- **图像格式**：`.bmp`
- **分辨率**：Original ROI **128 × 128** 像素
- **颜色通道**：**1 通道灰度图**
- **输入处理**：程序中统一 Resize 至 128×128，单通道输入。

### 2.3 样本统计与身份定义

对 `PalmBigDataBase/*.bmp` 进行遍历统计，结果如下：

- **图像总数**：**7752 张**
- **涉及人数（Person ID）**：**386 人**
- **身份类别（Identity Class）**：
  - **定义规则**：由于采集包含不同的光照/模态（Forward/Side），身份定义为 `Hand + ID`。
  - **公式**：`identity = Hand + "_" + ID` （例如 `F_100`, `S_100`）。
  - **总类别数**：**772 类**。
- **样本分布**：
  - 每个身份样本数：1 ~ 17 张。
  - 平均样本数：约 10 张/类。

### 2.4 文件命名与解析

- **命名格式**：`P_<Hand>_<ID>_<序号>.bmp`
- **字段解析**：
  - `P`：Palm（掌纹）。
  - `<Hand>`：`F` (Forward) / `S` (Side)，表示不同光照或模态。
  - `<ID>`：人物唯一编号（如 100）。
  - `<序号>`：同一个人同一模态下的样本索引。
- **解析示例**：
  - 文件名：`P_F_100_1.bmp` $\rightarrow$ 身份标签：`F_100`。

---

## 三、任务建模

### 3.1 核心研究问题

1. **构建认证系统**：在接触式掌纹 ROI 数据库上，实现低错误接受率（FAR）和低错误拒绝率（FRR）的 1:1 认证系统。
2. **模型对比**：对比**纯分类模型**（Softmax）与**深度度量学习模型**（Metric Learning）在特征判别性上的差异。
3. **前沿技术验证**：引入 **ArcFace**（角度间隔）与 **MobileOne**（端侧推理加速），验证其在掌纹任务中的有效性。

### 3.2 任务类型

1. **掌纹认证 (Verification, 1:1)**：
   - **输入**：两张掌纹图像。
   - **输出**：是否属于同一人（Binary Classification），基于特征距离判定。
   - **应用**：身份核验、门禁。

2. **掌纹识别 (Identification, 1:N)**（辅助任务）：
   - **输入**：一张查询图像。
   - **输出**：属于哪个 ID。
   - **作用**：用于预训练特征提取器，或结合 ArcFace 进行强监督学习。

### 3.3 整体技术路线

1. **预处理**：灰度读取 $\rightarrow$ Resize(128) $\rightarrow$ ToTensor $\rightarrow$ Normalize(0.5, 0.5)。
2. **骨干网络**：提取 128 维特征向量。
3. **训练策略**：
   - **阶段一**：分类训练（CrossEntropy / ArcFace）。
   - **阶段二**：度量学习微调（Contrastive / Triplet）。
4. **认证判决**：计算余弦距离 $d$，若 $d < T$ 则认证通过。

---

## 四、评价指标

### 4.1 分类任务指标

- **识别率 (Accuracy)**：
  $$ \text{Acc} = \frac{N_{\text{correct}}}{N_{\text{total}}} $$
  用于评估模型在固定类别闭集上的特征提取能力。

### 4.2 认证任务指标

1. **错误接受率 (FAR)**：冒充者被系统误认为合法用户的比例。
   $$ \text{FAR} = \frac{N_{\text{false accept}}}{N_{\text{impostor}}} \times 100\% $$
2. **错误拒绝率 (FRR)**：合法用户被系统误拒的比例。
   $$ \text{FRR} = \frac{N_{\text{false reject}}}{N_{\text{genuine}}} \times 100\% $$
3. **等错误率 (EER)**：FAR 与 FRR 曲线相交点（或差值最小点）的错误率，衡量系统综合性能。
4. **ROC / AUC**：受试者工作特征曲线及其曲线下面积。

### 4.3 判决准则

特征向量 $\mathbf{f}_1, \mathbf{f}_2$ 经 L2 归一化后，计算余弦距离：
$$ \cos(\theta) = \mathbf{f}_1 \cdot \mathbf{f}_2, \quad \text{Distance} = 1 - \cos(\theta) $$
- **判定**：Distance $< T$ $\rightarrow$ **Same Identity**。

---

## 五、语言、框架与程序结构

### 5.1 环境配置（语言和框架）

- **语言**：Python 3.11
- **框架**：PyTorch
- **库**：`torchvision`, `Pillow`, `numpy`, `pyyaml`, `tqdm`, `scikit-learn`

### 5.2 项目目录结构

```text
DL-learning/
├── palm/
│   ├── config.py       # 配置加载、随机种子、Transform定义
│   ├── datasets.py     # PalmDataset, AuthDataset, TripletDataset
│   ├── models.py       # INet, ResNetBackbone
│   ├── mobileone.py    # MobileOne (Re-parameterization)
│   ├── losses.py       # ContrastiveLoss, TripletLoss, ArcFaceLoss
│   ├── trainer.py      # 训练循环逻辑
│   └── evaluate.py     # 特征提取与指标计算
├── config/             # YAML 配置文件 (e.g., arcface.yml)
├── PalmBigDataBase/    # 数据源
├── args.yml            # 全局参数
└── run.py              # 主程序入口
```

### 5.3 程序框架与执行流程

- 命令行入口：`run.py`  
  - 解析参数（`mode`、`data_root`、`epochs`、`backbone` 等）  
  - 调用 `load_config`、`set_seed`、`get_transform` 完成配置与预处理  
- 训练阶段：  
  - `train_classifier`：分类训练（INet / ResNet / MobileOne + CE/Focal/MSE）  
  - `train_contrastive`：对比 / Triplet / Margin 度量学习训练  
  - `train_arcface_contrastive`：ArcFace + 对比混合训练  
- 评估阶段：  
  - 加载最佳权重（如 `best_contrastive_model.pth`）  
  - 使用 `ContrastivePairDataset(mode='test')` 构造成对数据  
  - 计算特征余弦距离，统计 FAR、FRR，并扫描阈值得到近似 EER，可选绘制 ROC 曲线  

---

## 六、算法原理

### 6.1 骨干网络 (Backbones)

#### 6.1.1 INet (FeatureNet)
- **结构**：3个卷积块（Conv-BN-ReLU-MaxPool）堆叠。
- **降维**：空间尺寸 $128 \rightarrow 64 \rightarrow 32 \rightarrow 16$。
- **输出**：Flatten 后接两层全连接，输出 128 维特征。

#### 6.1.2 MobileOne (可重参数化网络)
- **核心思想**：
  - **训练态**：多分支结构（3x3 Conv, 1x1 Conv, Identity），增强梯度流，提升准确率。
  - **推理态**：通过代数变换将多分支参数融合为一个等效的 3x3 卷积核。
- **优势**：在保持高精度的同时，推理阶段无多分支开销，速度极快（“One millisecond inference”）。
- **适配**：去掉原分类头，接入 128 维投影层。

#### 6.1.3 ResNet
- 使用 ResNet18/34，修改首层卷积适应单通道输入，用于作为性能基准（Baseline）。

### 6.2 损失函数 (Loss Functions)

#### 6.2.1 基础度量损失
- **对比损失 (Contrastive Loss)**：
  $$ L = y \cdot d^2 + (1-y) \cdot \max(0, m - d)^2 $$
  拉近正样本对，推开负样本对至 margin $m$ 之外。
- **三元组损失 (Triplet Loss)**：
  $$ L = \max(0, d(a, p) - d(a, n) + m) $$
  确保 Anchor 与 Positive 的距离比 Anchor 与 Negative 的距离小至少 $m$。

#### 6.2.2 ArcFace (角度间隔损失)
- **原理**：在特征向量与权重归一化的超球面上，对 Target Logit 引入角度间隔 $m$。
  $$ \text{Logit} = s \cdot \cos(\theta_{y} + m) $$
- **优势**：相比欧氏距离损失，ArcFace 在角度空间直接优化类间可分性和类内紧凑性，非常适合人脸/掌纹等细粒度认证。
- **混合训练**：`Loss = ArcFaceLoss + lambda * ContrastiveLoss`。

---

## 七、实验过程与分析

### 7.1 实验设置

- **数据划分**：
  - **分类/ArcFace**：按身份 8:2 划分训练集/验证集。
  - **度量学习**：构建正负样本对（Pair）或三元组（Triplet）。对于样本数 $\ge 10$ 的身份，前 5 张用于构建训练对，后 5 张用于构建测试对，确保**身份不重叠**（Open-set 设定）或**样本不重叠**。
- **参数**：Input 128x128, Feature Dim 128, Optimizer Adam, Epochs 30~50。

### 7.2 当前实验结果概览

> 说明：本节仅总结目前已经完成或部分完成的实验情况。部分模型和损失组合尚未充分收敛，具体数值留待后续补充。

#### 7.2.1 ResNet18 主实验

在多种配置中，目前效果相对最好的是以 **ResNet18** 为骨干网络的实验。典型配置如下：

- 骨干网络：ResNet18（单通道输入）  
- 任务：分类 + 认证（基于特征余弦距离）  
- 特征维度：128  
- 优化器：Adam，学习率与 epoch 数按照 `args.yml` 与默认配置设置  
- 数据划分：按身份 8:2 划分训练/验证集，测试时使用 `ContrastivePairDataset(mode="test")` 评估认证性能  

在上述配置下，ResNet18 的分类精度和基于特征的认证性能相对其他模型更稳定、数值也更高（具体准确率和 FAR/FRR 数值可在训练和评估日志中读取，并填入最终 Word 版表格中）。

#### 7.2.2 不同骨干网络的分类效果对比（目前阶段）

表 1：不同骨干网络的分类效果概况（当前阶段）

| 模型骨干 (Backbone) | 参数量 | 损失函数 | 验证集表现概况 |
| :--- | :--- | :--- | :--- |
| INet | Small | CE | 结果偏低，仍在调参（具体数值待补充） |
| **ResNet18** | Large | CE | **目前最优，精度相对最高（待填入实际数值）** |
| MobileOne | Medium | CE | 收敛不理想，需进一步调整学习率、epoch 等 |

> **分析**：从目前有限的实验来看，ResNet18 在相同训练轮数和超参数设置下整体表现较好；INet 和 MobileOne 由于训练轮数和超参数尚未充分调整，当前验证集精度偏低。后续若时间允许，可针对 MobileOne 单独设计超参数搜索，以更公平地比较轻量网络与 ResNet 的性能。

#### 7.2.3 不同损失函数的实验进展

表 2：不同损失函数在当前阶段的实验状态

| 损失函数          | 骨干网络        | 当前状态         | 现阶段观察                         |
| :-----------------|:----------------|:-----------------|:-----------------------------------|
| Softmax (CE)      | ResNet18        | 已完成基本实验   | 作为基线，在分类与认证上较为稳定   |
| Contrastive Loss  | ResNet18/MobileOne | 部分完成     | EER 有下降趋势，但结果仍有提升空间 |
| Triplet Loss      | ResNet18        | 未完全收敛       | 训练不稳定，需调整 margin 和 batch |
| ArcFace + Contrastive | ResNet18/MobileOne | 实验中   | 初步结果一般，需增加 epoch 并细致调参 |

> **分析**：目前主要完成了基于交叉熵的 ResNet18 基线实验，其他度量学习损失（对比、三元组、ArcFace 混合）仍处于探索阶段。尽管理论上 ArcFace + 度量学习有望进一步提升认证性能，但在掌纹任务上需要针对 margin、学习率、batch size 等参数进行细致调节，初始直接套用论文设置并不能立即获得理想结果。

### 7.3 阈值敏感性分析

随着阈值 $T$ 从 0.1 增加到 0.9：
- **FAR** 逐渐升高（放过更多冒充者）。
- **FRR** 逐渐降低（拒绝更少合法者）。
- 实验表明在 $T \approx 0.45 \sim 0.50$ 区间内，系统达到平衡状态（EER点），适合作为默认工作阈值。

---

## 八、结论与心得

### 8.1 主要结论
1. **深度度量学习与掌纹认证的适配性**：从任务特性和初步实验来看，基于特征距离的度量学习框架更适合 1:1 掌纹认证场景；本次工作中，以 ResNet18 为骨干的基线模型已经在分类与认证性能上表现出一定潜力。
2. **轻量模型的应用前景与挑战**：MobileOne 等轻量级网络在设计上非常适合移动端部署，但在掌纹数据集上要发挥其优势，还需要针对 margin、学习率和训练轮数进行更系统的调参与实验。
3. **数据规范性与局限性**：PalmBigDataBase 提供了对齐良好的掌纹 ROI，是模型稳定收敛的基础；但单通道灰度图在表达复杂纹理和光照变化方面仍有一定局限，未来可以考虑多模态或更丰富的采集方案。

### 8.2 心得体会
- **工程实践**：从数据清洗到 DataLoader 构建，再到模型训练与评估，构建了一个完整的闭环系统，深刻理解了深度学习落地的全流程。
- **算法理解**：通过实现 MobileOne 的重参数化过程和 ArcFace 的角度间隔损失，从代码层面加深了对前沿算法设计动机和细节的理解，即便部分实验结果尚未达到预期，也有助于掌握其适用条件和调参要点。
- **改进方向**：未来可在现有 ResNet18 基线的基础上，系统探索不同损失函数和超参数组合，同时引入更强的数据增强（旋转、遮挡、光照扰动等），并尝试多模态手部特征或非接触式掌纹的域适应研究。

---

## 九、参考文献

1. J. Deng, et al., "ArcFace: Additive Angular Margin Loss for Deep Face Recognition," CVPR, 2019.
2. H. Tu, et al., "MobileOne: An Improved One millisecond Mobile Backbone," arXiv, 2022.
3. F. Boutros, et al., "ElasticFace: Elastic Margin Loss for Deep Face Recognition," CVPR Workshops, 2022.
4. PyTorch Documentation & Torchvision References.
